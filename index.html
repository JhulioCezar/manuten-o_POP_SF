<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- ‚úÖ ALTERADO: Substituir html2pdf por jsPDF + html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<title>Ordem de Servi√ßo ‚Äì Manuten√ß√£o Preventiva POP</title>
<!-- ‚úÖ NOVO: Meta tags PWA -->
<meta name="theme-color" content="#0d6efd"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Manuten√ß√£o POP">
<link rel="icon" type="image/png" href="android-icon-192x192.png">
<link rel="apple-touch-icon" href="android-icon-192x192.png">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/icon-96x96.png">

<style>
  :root{
    --primary:#0d6efd;
    --bg:#f8f9fa;
    --card:#fff;
    --muted:#666;
  }
  *{box-sizing:border-box}
  body{
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    margin:0;
    background:var(--bg);
    color:#222;
    padding:20px 12px;
  }
  .container{
    max-width:1100px;
    margin:0 auto;
  }
  header{
    background:#fff;
    padding:12px 0;
    text-align:center;
    border-radius:10px;
    margin-bottom:14px;
  }
  header img{width:220px; height:auto;}
  h1{
    text-align:center;
    color:var(--primary);
    margin:12px 0;
    font-size:1.35rem;
  }
  form.card{
    background:var(--card);
    padding:18px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
  }
  .row{display:flex; gap:12px; flex-wrap:wrap;}
  .col{flex:1; min-width:200px;}
  label{display:block; font-weight:600; margin:8px 0 4px;}
  input[type="text"], input[type="date"], input[type="time"], input[type="datetime-local"], textarea, select {
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ccc;
    background:#fff;
    font-size:0.95rem;
  }
  textarea{min-height:68px; resize:vertical;}
  .small{max-width:140px;}
  .section{
    margin-top:18px;
    padding-top:12px;
    border-top:1px dashed #e6e6e6;
  }
  .section h2{color:var(--primary); margin:0 0 8px; font-size:1.05rem;}
  .item{
    background:#fafafa;
    border:1px solid #eee;
    padding:10px 12px;
    margin-bottom:12px;
    border-radius:8px;
  }
  .item-header{display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
  .item-header .title{font-weight:700;}
  .photo-preview{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  .photo-preview img{width:110px; height:80px; object-fit:cover; border-radius:6px; border:1px solid #ccc;}
  .sign-box{border:1px solid #ddd; border-radius:8px; padding:8px; background:#fff; text-align:center;}
  .sign-canvas{border:1px dashed #bbb; border-radius:6px; width:100%; height:140px; touch-action: none; background:#fff;}
  .btn{display:inline-block; padding:10px 14px; background:var(--primary); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;}
  .btn.secondary{background:#6c757d;}
  .meta{font-size:0.9rem; color:var(--muted)}
  .footer-actions{display:flex; gap:12px; justify-content:flex-end; margin-top:18px; flex-wrap:wrap;}

  /* üîß Corre√ß√£o de posi√ß√£o do bot√£o "Usar agora" */
  .datetime-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .datetime-group input[type="datetime-local"] {
    flex: 1;
    min-width: 0;
  }
  .datetime-group .btn {
    white-space: nowrap;
    padding: 8px 10px;
    font-size: 0.9rem;
  }

    /* Bot√£o personalizado "Inserir" */
      .file-input-wrapper {
        position: relative;
      display: inline-block;
      }
      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      .file-input-wrapper .custom-btn {
        display: inline-block;
        background: var(--primary);
        color: #fff;
        padding: 8px 14px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        border: none;
  }

/* Estilo para o container de preview e bot√£o apagar */
  .photo-preview-item {
    position: relative;
    display: inline-block;
    margin-right: 8px;
  }
  .photo-preview-item img {
    width: 110px; height: 80px; object-fit: cover;
    border-radius: 6px; border: 1px solid #ccc;
  }
  .delete-img-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #DB4437;
    color: white;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    line-height: 20px;
    text-align: center;
    padding: 0;
  }

  /* ‚úÖ NOVO: Loading overlay */
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  @media print{
    body{padding:0}
    .btn, .no-print{display:none!important}
    header, form.card{box-shadow:none; border:none; border-radius:0}
    .sign-canvas{border:none}
    
    /* ‚úÖ NOVAS REGRAS PARA IMPRESS√ÉO DE IMAGENS */
    .photo-preview-item {
        display: block;
        margin: 15px 0;
        page-break-inside: avoid;
    }
    
    .photo-preview-item img {
        width: auto !important;
        height: auto !important;
        max-width: 100% !important;
        max-height: 400px !important;
        object-fit: contain !important;
        border: 1px solid #ccc;
        border-radius: 6px;
    }
    
    .delete-img-btn {
        display: none !important;
    }
    
    /* Garantir que as se√ß√µes n√£o quebrem no meio */
    .item {
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    /* Melhor espa√ßamento para impress√£o */
    .item {
        margin-bottom: 20px;
        padding: 12px;
        background: #fff !important;
        border: 1px solid #ddd !important;
    }
}
</style>
</head>
<body>
  <!-- ‚úÖ NOVO: Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
      <h3>Gerando PDF e salvando no banco...</h3>
      <p>Isso pode levar alguns segundos</p>
    </div>
  </div>

  <div class="container">
    <header>
      <img src="https://i.imgur.com/SEr4lkm.png" alt="Sem Fronteiras UltraFibra">
    </header>

    <h1>ORDEM DE SERVI√áO ‚Äì MANUTEN√á√ÉO PREVENTIVA POP</h1>

    <form id="osForm" class="card" onsubmit="return false;">
      <!-- Cabe√ßalho dados -->
      <div class="row">
        <div class="col">
          <label>N¬∫ da OS</label>
          <input type="text" id="numeroOS" readonly />
          <div class="meta">Formato: <strong>NNN/AAAA</strong> (gerado automaticamente)</div>
        </div>

        <div class="col">
          <label>Data / Hora</label>
          <div class="datetime-group">
            <input type="datetime-local" id="dataHora" />
            <button type="button" id="btnUseNow" class="btn no-print">Usar agora</button>
          </div>
          <div class="meta">Voc√™ pode usar a data/hora atual ou editar manualmente.</div>
        </div>

        <div class="col">
          <label>Hora In√≠cio</label>
          <input type="time" id="horaInicio" />
          <div class="meta">Preenchido automaticamente na abertura (edit√°vel)</div>
        </div>

        <div class="col">
          <label>Hora T√©rmino</label>
          <input type="time" id="horaTermino" />
          <div class="meta">Ser√° preenchido automaticamente ao gerar/imprimir (edit√°vel)</div>
        </div>
      </div>

      <!-- POP e Endere√ßo -->
      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
          <h2 style="margin: 0;">Local (POP) / Endere√ßo / Localiza√ß√£o</h2>
          <button type="button" class="btn secondary no-print" style="padding: 6px 10px; font-size: 0.9rem;" onclick="clearPopFields()">Limpar</button>
        </div>
        <div class="row">
          <div class="col">
            <label>Local (POP)</label>
            <select id="popSelect">
              <option value="">-- Selecione o POP --</option>
            </select>
          </div>

          <div class="col">
            <label>Endere√ßo</label>
            <input type="text" id="endereco" autocomplete="off" />
          </div>

          <div class="col">
            <label>Localiza√ß√£o (Google Maps)</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input type="text" id="localizacao" readonly autocomplete="off" />
              <a id="mapsLink" href="#" target="_blank" style="display:inline-block; padding:8px 10px; background:#e9ecef; border-radius:8px; text-decoration:none;">Abrir</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o 1 -->
      <div class="section">
        <h2>1. Verifica√ß√£o da Infraestrutura e Condi√ß√µes Ambientais</h2>

        <!-- Item exemplo: 1.1 -->
        <div class="item">
          <div class="item-header">
            <div class="title">1.1 Limpeza do rack e equipamentos</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <select name="limpeza_rack_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="limpeza_rack_obs" placeholder="Observa√ß√µes..."></textarea>
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview1" class="imgInput" multiple>
            </div>
            <div id="preview1" class="photo-preview"></div>
          </div>
        </div>

        <!-- Item 1.2 -->
        <div class="item">
          <div class="item-header">
            <div class="title">1.2 Organiza√ß√£o dos cabos e patch cords</div>
            <div>
              <select name="cabos_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="cabos_obs" placeholder="Observa√ß√µes..."></textarea>

          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview2" class="imgInput" multiple>
            </div>
            <div id="preview2" class="photo-preview"></div>
          </div>
        </div>

        <!-- Item 1.3 -->
        <div class="item">
          <div class="item-header">
            <div class="title">1.3 Temperatura ambiente (¬∞C)</div>
            <div>
              <select name="temp_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes / Valor (¬∞C)</label>
          <input type="text" name="temp_obs" placeholder="Ex: 24¬∞C - Observa√ß√µes..." />
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview3" class="imgInput" multiple>
            </div>
            <div id="preview3" class="photo-preview"></div>
          </div>
        </div>

        <!-- Item 1.4 -->
        <div class="item">
          <div class="item-header">
            <div class="title">1.4 Ventila√ß√£o / ar-condicionado</div>
            <div>
              <select name="vent_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="vent_obs" placeholder="Observa√ß√µes..."></textarea>
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview4" class="imgInput" multiple>
            </div>
            <div id="preview4" class="photo-preview"></div>
          </div>
        </div>

        <!-- Item 1.5 -->
        <div class="item">
          <div class="item-header">
            <div class="title">1.5 Porta e fechaduras do POP</div>
            <div>
              <select name="porta_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="porta_obs" placeholder="Observa√ß√µes..."></textarea>
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview5" class="imgInput" multiple>
            </div>
            <div id="preview5" class="photo-preview"></div>
          </div>
        </div>

        <!-- Item 1.6 -->
        <div class="item">
          <div class="item-header">
            <div class="title">1.6 Identifica√ß√£o de equipamentos e cabos</div>
            <div>
              <select name="id_equip_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="id_equip_obs" placeholder="Observa√ß√µes..."></textarea>
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview6" class="imgInput" multiple>
            </div>
            <div id="preview6" class="photo-preview"></div>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o 2 -->
      <div class="section">
        <h2>2. Manuten√ß√£o dos Equipamentos Principais</h2>

        <div class="item">
          <div class="item-header">
            <div class="title">2.1 OLT (Optical Line Terminal)</div>
            <div>
              <select name="olt_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="olt_obs" placeholder="Observa√ß√µes..."></textarea>
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview7" class="imgInput" multiple>
            </div>
            <div id="preview7" class="photo-preview"></div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="title">2.2 Switch (SW)</div>
            <div>
              <select name="sw_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="sw_obs" placeholder="Observa√ß√µes..."></textarea>
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview8" class="imgInput" multiple>
            </div>
            <div id="preview8" class="photo-preview"></div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="title">2.3 Retificadora e Baterias</div>
            <div>
              <select name="ret_status" class="small">
                <option value="">Selecione</option>
                <option value="ok">OK</option>
                <option value="nao_ok">N√£o OK</option>
              </select>
            </div>
          </div>
          <label>Observa√ß√µes</label>
          <textarea name="ret_obs" placeholder="Observa√ß√µes..."></textarea>
          <div style="margin-top:8px;">
            <label>Imagem de comprova√ß√£o</label>
            <div class="file-input-wrapper">
              <button type="button" class="custom-btn">Inserir</button>
              <input type="file" accept="image/*" capture="environment" data-preview="preview9" class="imgInput" multiple>
            </div>
            <div id="preview9" class="photo-preview"></div>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o 3 -->
      <div class="section">
        <h2>3. A√ß√µes Corretivas e Observa√ß√µes</h2>
        <label>A√ß√µes realizadas</label>
        <textarea name="acoes_realizadas"></textarea>

        <label style="margin-top:8px;">Observa√ß√µes / Recomenda√ß√µes</label>
        <textarea name="observacoes_recomendacoes"></textarea>
      </div>

      <!-- Pr√≥xima manuten√ß√£o -->
      <div class="section">
        <h2>4. Pr√≥xima Manuten√ß√£o</h2>
        <label>Data estimada</label>
        <input type="date" id="dataEstimada" />
        <div class="meta">Preenchida automaticamente com +3 meses (edit√°vel)</div>
      </div>

      <!-- Assinaturas -->
      <div class="section">
        <h2>Assinaturas</h2>
        <div class="row">
          <div class="col">
            <label>Assinatura do T√©cnico</label>
            <div class="sign-box">
              <canvas id="sigTech" class="sign-canvas"></canvas>
              <div style="display:flex; gap:8px; margin-top:8px; justify-content:center;">
                <button type="button" class="btn secondary no-print" onclick="clearSig('sigTech')">Limpar</button>
                <button type="button" class="btn no-print" onclick="saveSig('sigTech','sigTechImg')">Salvar assinatura</button>
              </div>
              <input type="hidden" id="sigTechImg" />
              <div id="sigTechPreview" style="margin-top:8px;"></div>
            </div>
          </div>

          <div class="col">
            <label>Assinatura do Respons√°vel (Cliente/Supervisor)</label>
            <div class="sign-box">
              <canvas id="sigResp" class="sign-canvas"></canvas>
              <div style="display:flex; gap:8px; margin-top:8px; justify-content:center;">
                <button type="button" class="btn secondary no-print" onclick="clearSig('sigResp')">Limpar</button>
                <button type="button" class="btn no-print" onclick="saveSig('sigResp','sigRespImg')">Salvar assinatura</button>
              </div>
              <input type="hidden" id="sigRespImg" />
              <div id="sigRespPreview" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- a√ß√µes -->
      <div class="footer-actions no-print">
        <button type="button" class="btn secondary" onclick="limparFormulario()">Limpar Formul√°rio</button>
        <button type="button" class="btn" onclick="generateAndPrint()">Gerar e Baixar PDF</button>
      </div>
    </form>
  </div>

<script>
// ‚úÖ NOVO: Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
                console.log('ServiceWorker registrado: ', registration.scope);
            })
            .catch(function(error) {
                console.log('Falha no ServiceWorker: ', error);
            });
    });
}

/* ========== Dados dos POPs (ordenados alfabeticamente) ========== */
const pops = [
  {name:"4 Bocas", address:"Br 364 km 25 sentido - Porto Velho, Rio Branco - AC, 69900-000", maps:"https://maps.app.goo.gl/iRFgi4HiX6qroz1X8"},
  {name:"Acrel√¢ndia", address:"Acrel√¢ndia, Acre", maps:"https://maps.app.goo.gl/uAzxTA8C54GQtmTE8"},
  {name:"Albert Sampaio", address:"Rodovia BR-364 Albert Sampaio, Rio Branco - AC, 69909-040", maps:"https://maps.app.goo.gl/1kQs6jH4PpJN8mKf8"},
  {name:"Assis Brasil", address:"Ipiranga, Assis Brasil - AC, 69935-000", maps:"https://maps.app.goo.gl/zafXZppgL2Yae3Bu5"},
  {name:"Belo Jardim", address:"Tv. Isa√≠as, 208 - Belo Jardim I, Rio Branco - AC, 69907-848", maps:"https://maps.app.goo.gl/FnPmXhj7hSdbp6sA6"},
  {name:"Benfica", address:"Benfica, Rio Branco, Acre", maps:"https://maps.app.goo.gl/6BLpDpxT9QFggr5eA"},
  {name:"Bom Jesus", address:"Vila Acre, Rio Branco - AC", maps:"https://maps.app.goo.gl/7ARa5NroqG1rEUMq7"},
  {name:"Bujari", address:"Bujari, AC, 69923-000", maps:"https://maps.app.goo.gl/gYnGmjFqhXHHL52aA"},
  {name:"Calafate", address:"R. Abun√£, 81 - Portal da Amaz√¥nia, Rio Branco - AC, 69915-840", maps:"https://maps.app.goo.gl/XeTCvk7LhbRCwkpNA"},
  {name:"Capixaba", address:"Capixaba, AC, 69922-000", maps:"https://maps.app.goo.gl/T5aC4EG1VsuKBsDz5"},
  {name:"Cidade do Povo", address:"Cidade do Povo, Rio Branco - AC, 69925-000", maps:"https://maps.app.goo.gl/c7ycJ1PGT3MFTDkn6"},
  {name:"Data Center", address:"R. Bertioga, 131-61 - Vila Ivonete, Rio Branco - AC, 69914-570", maps:"https://maps.app.goo.gl/9oS3kq45e6Han7hH8"},
  {name:"Esperan√ßa", address:"R. S√£o Jos√©, 376 - Nova Esperan√ßa, Rio Branco - AC, 69915-202", maps:"https://maps.app.goo.gl/C4Veu4rWL7yH1mfy7"},
  {name:"Feij√≥", address:"BR-364, 122, Feij√≥ - AC, 69960-000", maps:"https://maps.app.goo.gl/3SSLGh2rvsDBFVn29"},
  {name:"Liberdade", address:"BR-364, Tarauac√° - AC, 69970-000", maps:"https://maps.app.goo.gl/HjJkKVHR1Bcr1U2o7"},
  {name:"M√¢ncio Lima", address:"R Jo√£o B Rodrigues, 428 - Centro, M√¢ncio Lima - AC, 69900-970", maps:"https://maps.app.goo.gl/fG5f81v4jcBbiXcPA"},
  {name:"Manoel Urbano", address:"Manoel Urbano, Acre", maps:"https://maps.app.goo.gl/7wEyk5Gj9RYn7aNw7"},
  {name:"Maison Borges", address:"Distrito Industrial, Rio Branco - AC", maps:"https://maps.app.goo.gl/tMVds5Jq6mwRnEUF7"},
  {name:"Part e Alta", address:"R. Jo√£o Francisco da Cunha, 39 - Conj Procom, Rio Branco - AC, 69918-632", maps:"https://maps.app.goo.gl/25wwXie6vogyE8az8"},
  {name:"Pl√°cido de Castro", address:"R. Diamantino A De Macedo, 1112 - Pl√°cido De Castro, Pl√°cido de Castro - AC, 69928-000", maps:"https://maps.app.goo.gl/xGRWkw3g1c5X9JPd6"},
  {name:"Porto Acre", address:"Porto Acre, Acre, 69921-000", maps:"https://maps.app.goo.gl/CYFdELdKAQ1XAGkP8"},
  {name:"Pra Parte Alta", address:"R. Jo√£o Francisco da Cunha, 39 - Conj Procom, Rio Branco - AC, 69918-632", maps:"https://maps.app.goo.gl/25wwXie6vogyE8az8"},
  {name:"Rodrigues Alves", address:"Av. Projeto Rondon, 2-18, Rodrigues Alves - AC, 69985-000", maps:"https://maps.app.goo.gl/c9991Hv3q6eX1UdR8"},
  {name:"Sobral", address:"R. Principal, 179-1 - Palheiral, Rio Branco - AC, 69903-830", maps:"https://maps.app.goo.gl/HEW8efJ7mD5EoLx49"},
  {name:"Sena Madureira ( Cidade )", address:"R. Walter Wilton Maia, 169 - Sena Madureira, AC, 69940-000", maps:"https://maps.app.goo.gl/ZpW4qPWwk426BwQJ8"},
  {name:"Sena Madureira ( Estrada )", address:"Sena Madureira, Acre", maps:"https://maps.app.goo.gl/bDMJo91eqv7noue3A"},
  {name:"Senador Guiomard (Quinari)", address:"Sen. Guiomard, AC", maps:"https://maps.app.goo.gl/cTPPaNfiA1y8qiqn9"},
  {name:"Tancredo Neves", address:"Estrada Raimundo Irineu Serra - Novo Horizonte, Rio Branco - AC, 69918-505", maps:"https://maps.app.goo.gl/BB4sHicRV9fFmL7p9"},
  {name:"Tarauac√°", address:"R. Floriano Peixoto, Tarauac√° - AC, 69970-000", maps:"https://maps.app.goo.gl/uZp1eHpGair9AqUW7"},
  {name:"Trevo Rodrigues Alves", address:"BR-364, Cruzeiro do Sul - AC, 69980-000", maps:"https://maps.app.goo.gl/csPQGbGUHtxnhSCNA"},
  {name:"Vila Caquet√°", address:"BR-317, 20191 - Vila Caquet√°, Sen. Guiomard - AC, 69925-000", maps:"https://maps.app.goo.gl/5s3hwEwwJhU17H9G7"},
  {name:"Xapuri ( Cidade )", address:"R. Na√ß√µes Unidas, 1143 - Centro, Xapuri - AC, 69930-000", maps:"https://maps.app.goo.gl/FV8RExFPezVrZMA69"},
  {name:"Xapuri (Posto)", address:"Auto Posto Entroncamento Petrobras, Xapuri - AC, 69930-000", maps:"https://maps.app.goo.gl/1z6WPwejPAZ6iq369"},
];

/* ========== Inje√ß√£o do select de POPs ========== */
function populatePOP(){
  const sel = document.getElementById('popSelect');
  pops.sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'));
  pops.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.name;
    opt.dataset.address = p.address;
    opt.dataset.maps = p.maps;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
}

/* ========== Limpar Campos do POP ========== */
function clearPopFields() {
    document.getElementById('popSelect').value = "";
    document.getElementById('endereco').value = "";
    document.getElementById('localizacao').value = "";
    const link = document.getElementById('mapsLink');
    link.href = '#';
    link.style.pointerEvents = 'none';
    link.style.opacity = 0.5;
}

/* ========== Autopreencher Observa√ß√µes com "OK" ========== */
document.addEventListener('change', function(e) {
    const target = e.target;
    if (target.tagName === 'SELECT' && target.name && target.name.endsWith('_status')) {
        const item = target.closest('.item');
        if (!item) return;
        const obsField = item.querySelector('textarea[name$="_obs"], input[type="text"][name$="_obs"]');
        if (!obsField) return;

        const autoFillText = "Conforme as normas t√©cnicas exigidas";

        if (target.value === 'ok') {
            if (obsField.value.trim() === '') {
                obsField.value = autoFillText;
            }
        } else {
            if (obsField.value.trim() === autoFillText) {
                obsField.value = "";
            }
        }
    }
});

/* ========== Preenchimento POP -> endere√ßo & maps ========== */
document.addEventListener('change', function(e){
  if(e.target && e.target.id === 'popSelect'){
    const opt = e.target.selectedOptions[0];
    if(!opt) return;
    const address = opt.dataset.address || '';
    const maps = opt.dataset.maps || '';
    document.getElementById('endereco').value = address;
    const locInput = document.getElementById('localizacao');
    locInput.value = maps;
    const link = document.getElementById('mapsLink');
    if(maps){
      link.href = maps;
      link.style.pointerEvents = 'auto';
      link.style.opacity = 1;
    } else {
      link.href = '#';
      link.style.pointerEvents = 'none';
      link.style.opacity = 0.5;
    }
  }
});

/* ========== Gera√ß√£o N¬∫ OS autom√°tico por ano ========== */
function gerarNumeroOS(){
  const ano = new Date().getFullYear();
  const key = 'os_counter_' + ano;
  let counter = parseInt(localStorage.getItem(key) || '0', 10);
  counter = counter + 1;
  localStorage.setItem(key, counter.toString());
  const numero = String(counter).padStart(3,'0') + '/' + ano;
  document.getElementById('numeroOS').value = numero;
}

/* ========== Data/Hora e Horas preenchidas automaticamente ========== */
function fillNowDateTime(){
  const now = new Date();
  const pad = n=>String(n).padStart(2,'0');
  const dtLocal = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
  document.getElementById('dataHora').value = dtLocal;
}
function fillHoraInicio(){
  const now = new Date();
  const pad = n=>String(n).padStart(2,'0');
  document.getElementById('horaInicio').value = pad(now.getHours()) + ':' + pad(now.getMinutes());
}
function fillHoraTermino(){
  const now = new Date();
  const pad = n=>String(n).padStart(2,'0');
  document.getElementById('horaTermino').value = pad(now.getHours()) + ':' + pad(now.getMinutes());
}

/* ========== Data estimada +3 meses ========== */
function fillDataEstimadaPlus3(){
  const hoje = new Date();
  const dt = new Date(hoje);
  dt.setMonth(dt.getMonth()+3);
  const pad = n=>String(n).padStart(2,'0');
  const val = dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate());
  document.getElementById('dataEstimada').value = val;
}

/* ========== Pr√©-visualiza√ß√£o, Compress√£o e Bot√£o Apagar ========== */
const formImages = {}; 

function handleImageInputChange(input) {
    const previewId = input.dataset.preview;
    const container = document.getElementById(previewId);
    
    const files = input.files;
    if (!files || files.length === 0) return;

    const MAX_WIDTH = 800;
    const QUALITY = 0.7;

    for (let i = 0; i < files.length; i++) {
        const f = files[i];
        
        (function(file) {
            const reader = new FileReader();
            
            reader.onload = function(ev) {
                const img = new Image();
                img.src = ev.target.result;
                
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height = height * (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', QUALITY);
                    
                    if (!formImages[previewId]) {
                        formImages[previewId] = [];
                    }
                    
                    const imageIndex = formImages[previewId].push(dataUrl) - 1;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'photo-preview-item';
                    wrapper.id = `img-${previewId}-${imageIndex}`;

                    const previewImg = document.createElement('img');
                    previewImg.src = dataUrl;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete-img-btn';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.onclick = function() { deleteImage(previewId, imageIndex); };

                    wrapper.appendChild(previewImg);
                    wrapper.appendChild(deleteBtn);
                    container.appendChild(wrapper);
                };
            };
            reader.readAsDataURL(file);
        })(f);
    }
    
    input.value = null;
}

document.addEventListener('change', function(e){
  if(e.target && e.target.classList && e.target.classList.contains('imgInput')){
    handleImageInputChange(e.target);
  }
});

/* ========== Assinaturas (Canvas) ========== */
function initSignatureCanvas(id){
  const canvas = document.getElementById(id);
  const ctx = canvas.getContext('2d');
  resizeCanvasToDisplaySize(canvas);
  ctx.strokeStyle = '#111';
  ctx.lineWidth = 2.0;
  let drawing = false;
  let lastX=0, lastY=0;

  function getPointer(e){
    const rect = canvas.getBoundingClientRect();
    let clientX, clientY;
    if(e.touches){
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    return {x: clientX - rect.left, y: clientY - rect.top};
  }
  function start(e){
    drawing = true;
    const p = getPointer(e);
    lastX = p.x; lastY = p.y;
    e.preventDefault();
  }
  function move(e){
    if(!drawing) return;
    const p = getPointer(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    lastX = p.x; lastY = p.y;
    e.preventDefault();
  }
  function stop(e){
    drawing = false;
    e.preventDefault();
  }
  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  window.addEventListener('mouseup', stop);
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove', move, {passive:false});
  canvas.addEventListener('touchend', stop);

  return {
    clear: function(){ ctx.clearRect(0,0,canvas.width,canvas.height); },
    toDataURL: function(){ return canvas.toDataURL('image/png'); }
  };
}
function resizeCanvasToDisplaySize(canvas){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr,dpr);
}
function clearSig(id){
  const c = document.getElementById(id);
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  if(id==='sigTech') document.getElementById('sigTechPreview').innerHTML='';
  if(id==='sigResp') document.getElementById('sigRespPreview').innerHTML='';
  if(id==='sigTechImg') document.getElementById('sigTechImg').value='';
  if(id==='sigRespImg') document.getElementById('sigRespImg').value='';
}

function saveSig(canvasId, hiddenInputId){
  const c = document.getElementById(canvasId);
  const data = c.toDataURL('image/png', 0.8); 
  document.getElementById(hiddenInputId).value = data;
  const previewId = (canvasId==='sigTech') ? 'sigTechPreview' : 'sigRespPreview';
  document.getElementById(previewId).innerHTML = '<img src="'+data+'" style="max-width:220px; border:1px solid #ccc; border-radius:6px;" />';
}

/* ========== Salvar rascunho local (localStorage) ========== */
function gatherFormData(){
  const form = document.getElementById('osForm');
  const data = {};
  const fd = new FormData(form);
  data.numeroOS = document.getElementById('numeroOS').value;
  data.dataHora = document.getElementById('dataHora').value;
  data.horaInicio = document.getElementById('horaInicio').value;
  data.horaTermino = document.getElementById('horaTermino').value;
  data.pop = document.getElementById('popSelect').value;
  data.endereco = document.getElementById('endereco').value;
  data.localizacao = document.getElementById('localizacao').value;
  data.dataEstimada = document.getElementById('dataEstimada').value;

  data.sigTech = document.getElementById('sigTechImg').value || null;
  data.sigResp = document.getElementById('sigRespImg').value || null;

  data.images = JSON.parse(JSON.stringify(formImages));

  const names = ['limpeza_rack_status','limpeza_rack_obs','cabos_status','cabos_obs',
                 'temp_status','temp_obs','vent_status','vent_obs','porta_status','porta_obs',
                 'id_equip_status','id_equip_obs','olt_status','olt_obs','sw_status','sw_obs',
                 'ret_status','ret_obs','acoes_realizadas','observacoes_recomendacoes'];
  names.forEach(n=>{
    data[n] = fd.getAll(n).join(', ') || fd.get(n) || '';
  });
  return data;
}

/* ========== Apagar Imagem Individual ========== */
function deleteImage(previewId, index) {
    if (formImages[previewId] && formImages[previewId][index]) {
        formImages[previewId][index] = null; 
    }
    
    const wrapper = document.getElementById(`img-${previewId}-${index}`);
    if (wrapper) {
        wrapper.parentNode.removeChild(wrapper);
    }
}

/* ========== ‚úÖ ALTERADO: Gerar PDF com jsPDF (nova implementa√ß√£o) ========== */
async function generateAndPrint() {
    if (!validarFormularioManutencao()) return;
    
    try {
        // Mostrar loading
        const btn = document.querySelector('button[onclick="generateAndPrint()"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Gerando PDF...';

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const margin = 15;
        let y = 15;

        // Logo
        let logoBase64 = null;
        try { 
            logoBase64 = await getImageBase64('https://i.imgur.com/SEr4lkm.png'); 
        } catch(e) { 
            console.warn('Logo n√£o carregada:', e); 
        }
        
        if (logoBase64) { 
            const logoW = 50, logoX = (pageWidth - logoW) / 2; 
            pdf.addImage(logoBase64, 'PNG', logoX, y, logoW, 12); 
            y += 18; 
        }

        // T√≠tulo
        pdf.setFontSize(18);
        pdf.setFont(undefined, 'bold');
        pdf.text('ORDEM DE SERVI√áO ‚Äì MANUTEN√á√ÉO PREVENTIVA POP', pageWidth / 2, y, { align: 'center' });
        y += 12;

        // Informa√ß√µes Gerais
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'normal');
        
        const formData = gatherFormData();
        
        // N√∫mero OS
        pdf.setFont(undefined, 'bold');
        pdf.text('N¬∫ da OS:', margin, y);
        pdf.setFont(undefined, 'normal');
        pdf.text(formData.numeroOS || 'N/A', margin + 20, y);
        
        // Data/Hora
        pdf.setFont(undefined, 'bold');
        pdf.text('Data/Hora:', pageWidth / 2, y);
        pdf.setFont(undefined, 'normal');
        pdf.text(formData.dataHora || 'N/A', pageWidth / 2 + 25, y);
        y += 7;

        // POP
        pdf.setFont(undefined, 'bold');
        pdf.text('Local (POP):', margin, y);
        pdf.setFont(undefined, 'normal');
        pdf.text(formData.pop || 'N/A', margin + 25, y);
        
        // Endere√ßo
        pdf.setFont(undefined, 'bold');
        pdf.text('Endere√ßo:', pageWidth / 2, y);
        pdf.setFont(undefined, 'normal');
        const enderecoLines = pdf.splitTextToSize(formData.endereco || 'N/A', 70);
        pdf.text(enderecoLines, pageWidth / 2 + 20, y);
        y += (enderecoLines.length * 5) + 5;

        // Hor√°rios
        pdf.setFont(undefined, 'bold');
        pdf.text('Hora In√≠cio:', margin, y);
        pdf.setFont(undefined, 'normal');
        pdf.text(formData.horaInicio || 'N/A', margin + 25, y);
        
        pdf.setFont(undefined, 'bold');
        pdf.text('Hora T√©rmino:', pageWidth / 2, y);
        pdf.setFont(undefined, 'normal');
        pdf.text(formData.horaTermino || 'N/A', pageWidth / 2 + 30, y);
        y += 10;

        // Se√ß√£o 1: Infraestrutura
        pdf.setFont(undefined, 'bold');
        pdf.setFontSize(12);
        pdf.text('1. Verifica√ß√£o da Infraestrutura e Condi√ß√µes Ambientais', margin, y);
        y += 8;

        // Itens da se√ß√£o 1
        const itensSecao1 = [
            { titulo: '1.1 Limpeza do rack e equipamentos', status: formData.limpeza_rack_status, obs: formData.limpeza_rack_obs },
            { titulo: '1.2 Organiza√ß√£o dos cabos e patch cords', status: formData.cabos_status, obs: formData.cabos_obs },
            { titulo: '1.3 Temperatura ambiente (¬∞C)', status: formData.temp_status, obs: formData.temp_obs },
            { titulo: '1.4 Ventila√ß√£o / ar-condicionado', status: formData.vent_status, obs: formData.vent_obs },
            { titulo: '1.5 Porta e fechaduras do POP', status: formData.porta_status, obs: formData.porta_obs },
            { titulo: '1.6 Identifica√ß√£o de equipamentos e cabos', status: formData.id_equip_status, obs: formData.id_equip_obs }
        ];

        pdf.setFontSize(10);
        for (const item of itensSecao1) {
            if (y > 250) {
                pdf.addPage();
                y = 20;
            }

            pdf.setFont(undefined, 'bold');
            pdf.text(item.titulo, margin, y);
            
            pdf.setFont(undefined, 'normal');
            pdf.text(`Status: ${item.status || 'N/A'}`, margin + 80, y);
            
            y += 5;
            
            if (item.obs) {
                const obsLines = pdf.splitTextToSize(`Obs: ${item.obs}`, pageWidth - margin * 2);
                pdf.text(obsLines, margin, y);
                y += (obsLines.length * 4) + 3;
            } else {
                y += 5;
            }
            
            // Linha separadora
            pdf.line(margin, y, pageWidth - margin, y);
            y += 5;
        }

        // Se√ß√£o 2: Equipamentos Principais
        y += 5;
        pdf.setFont(undefined, 'bold');
        pdf.setFontSize(12);
        pdf.text('2. Manuten√ß√£o dos Equipamentos Principais', margin, y);
        y += 8;

        const itensSecao2 = [
            { titulo: '2.1 OLT (Optical Line Terminal)', status: formData.olt_status, obs: formData.olt_obs },
            { titulo: '2.2 Switch (SW)', status: formData.sw_status, obs: formData.sw_obs },
            { titulo: '2.3 Retificadora e Baterias', status: formData.ret_status, obs: formData.ret_obs }
        ];

        pdf.setFontSize(10);
        for (const item of itensSecao2) {
            if (y > 250) {
                pdf.addPage();
                y = 20;
            }

            pdf.setFont(undefined, 'bold');
            pdf.text(item.titulo, margin, y);
            
            pdf.setFont(undefined, 'normal');
            pdf.text(`Status: ${item.status || 'N/A'}`, margin + 80, y);
            
            y += 5;
            
            if (item.obs) {
                const obsLines = pdf.splitTextToSize(`Obs: ${item.obs}`, pageWidth - margin * 2);
                pdf.text(obsLines, margin, y);
                y += (obsLines.length * 4) + 3;
            } else {
                y += 5;
            }
            
            pdf.line(margin, y, pageWidth - margin, y);
            y += 5;
        }

        // A√ß√µes Corretivas
        if (formData.acoes_realizadas || formData.observacoes_recomendacoes) {
            y += 5;
            pdf.setFont(undefined, 'bold');
            pdf.setFontSize(12);
            pdf.text('3. A√ß√µes Corretivas e Observa√ß√µes', margin, y);
            y += 8;

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            if (formData.acoes_realizadas) {
                pdf.setFont(undefined, 'bold');
                pdf.text('A√ß√µes realizadas:', margin, y);
                y += 5;
                pdf.setFont(undefined, 'normal');
                const acoesLines = pdf.splitTextToSize(formData.acoes_realizadas, pageWidth - margin * 2);
                pdf.text(acoesLines, margin, y);
                y += (acoesLines.length * 4) + 5;
            }

            if (formData.observacoes_recomendacoes) {
                pdf.setFont(undefined, 'bold');
                pdf.text('Observa√ß√µes/Recomenda√ß√µes:', margin, y);
                y += 5;
                pdf.setFont(undefined, 'normal');
                const obsLines = pdf.splitTextToSize(formData.observacoes_recomendacoes, pageWidth - margin * 2);
                pdf.text(obsLines, margin, y);
                y += (obsLines.length * 4) + 5;
            }
        }

        // Pr√≥xima Manuten√ß√£o
        if (formData.dataEstimada) {
            y += 5;
            pdf.setFont(undefined, 'bold');
            pdf.setFontSize(12);
            pdf.text('4. Pr√≥xima Manuten√ß√£o', margin, y);
            y += 8;

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Data estimada: ${formData.dataEstimada}`, margin, y);
            y += 10;
        }

        // Assinaturas (nova p√°gina)
        pdf.addPage();
        y = 30;
        
        pdf.setFont(undefined, 'bold');
        pdf.setFontSize(14);
        pdf.text('ASSINATURAS', pageWidth / 2, y, { align: 'center' });
        y += 20;

        // Assinatura T√©cnico
        if (formData.sigTech) {
            try {
                const sigTechProps = pdf.getImageProperties(formData.sigTech);
                const sigW = 70;
                const sigH = (sigTechProps.height * sigW) / sigTechProps.width;
                pdf.addImage(formData.sigTech, 'PNG', margin + 20, y, sigW, sigH);
                pdf.line(margin + 20, y + sigH + 2, margin + 20 + sigW, y + sigH + 2);
                pdf.setFontSize(10);
                pdf.text('Assinatura do T√©cnico', margin + 20 + (sigW / 2), y + sigH + 8, { align: 'center' });
            } catch(e) {
                console.warn('Erro ao adicionar assinatura t√©cnica:', e);
            }
        }

        // Assinatura Respons√°vel
        if (formData.sigResp) {
            try {
                const sigRespProps = pdf.getImageProperties(formData.sigResp);
                const sigW = 70;
                const sigH = (sigRespProps.height * sigW) / sigRespProps.width;
                pdf.addImage(formData.sigResp, 'PNG', pageWidth - margin - 20 - sigW, y, sigW, sigH);
                pdf.line(pageWidth - margin - 20 - sigW, y + sigH + 2, pageWidth - margin - 20, y + sigH + 2);
                pdf.setFontSize(10);
                pdf.text('Assinatura do Respons√°vel', pageWidth - margin - 20 - (sigW / 2), y + sigH + 8, { align: 'center' });
            } catch(e) {
                console.warn('Erro ao adicionar assinatura respons√°vel:', e);
            }
        }

        // Imagens das verifica√ß√µes
        if (formData.images && Object.keys(formData.images).length > 0) {
            for (const [previewId, images] of Object.entries(formData.images)) {
                for (let i = 0; i < images.length; i++) {
                    if (images[i]) {
                        try {
                            pdf.addPage();
                            y = 20;
                            pdf.setFont(undefined, 'bold');
                            pdf.setFontSize(14);
                            pdf.text(`Imagem de Comprova√ß√£o - ${previewId.replace('preview', 'Item ')}`, pageWidth / 2, y, { align: 'center' });
                            y += 15;

                            const imgProps = pdf.getImageProperties(images[i]);
                            const maxW = pageWidth - margin * 2;
                            const maxH = 200;
                            const ratio = Math.min(maxW / imgProps.width, maxH / imgProps.height);
                            const w = imgProps.width * ratio;
                            const h = imgProps.height * ratio;
                            const x = (pageWidth - w) / 2;
                            
                            pdf.addImage(images[i], 'JPEG', x, y, w, h);
                        } catch(e) {
                            console.warn('Erro ao adicionar imagem ao PDF:', e);
                        }
                    }
                }
            }
        }

        // Salvar PDF
        const fileName = `OS-${formData.numeroOS || 'manutencao'}.pdf`;
        pdf.save(fileName);

        // Restaurar bot√£o
        btn.disabled = false;
        btn.textContent = originalText;
        
        alert('‚úÖ PDF gerado com sucesso!\n\nArquivo: ' + fileName);

    } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        alert('‚ùå Erro ao gerar PDF: ' + error.message);
        
        const btn = document.querySelector('button[onclick="generateAndPrint()"]');
        btn.disabled = false;
        btn.textContent = 'Gerar e Baixar PDF';
    }
}

/* ========== ‚úÖ NOVA FUN√á√ÉO: Validar formul√°rio manuten√ß√£o ========== */
function validarFormularioManutencao() {
    const faltando = [];

    const numeroOS = document.getElementById('numeroOS').value.trim();
    if (!numeroOS) faltando.push("N√∫mero da OS");

    const pop = document.getElementById('popSelect').value.trim();
    if (!pop) faltando.push("Local (POP)");

    const endereco = document.getElementById('endereco').value.trim();
    if (!endereco) faltando.push("Endere√ßo");

    // Verificar se h√° pelo menos uma verifica√ß√£o preenchida
    const temVerificacao = document.querySelectorAll('select[name$="_status"]:not([value=""])').length > 0;
    if (!temVerificacao) faltando.push("Pelo menos uma verifica√ß√£o preenchida");

    if (faltando.length > 0) {
        alert("‚ö†Ô∏è Antes de gerar o PDF, preencha os seguintes campos:\n\n‚Ä¢ " + faltando.join("\n‚Ä¢ "));
        return false;
    }

    return true;
}

/* ========== ‚úÖ NOVA FUN√á√ÉO: Converter imagem para base64 ========== */
function getImageBase64(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = (e) => reject(e);
        img.src = url;
    });
}

/* ========== ‚úÖ NOVO: Limpar todo o formul√°rio ========== */
function limparFormulario() {
    if (!confirm('Tem certeza que deseja limpar todos os campos do formul√°rio?\nTodos os dados n√£o salvos ser√£o perdidos.')) {
        return;
    }

    // Limpar campos b√°sicos
    document.getElementById('osForm').reset();
    
    // Limpar n√∫mero da OS (ser√° regenerado)
    gerarNumeroOS();
    
    // Limpar data/hora atual
    fillNowDateTime();
    fillHoraInicio();
    fillDataEstimadaPlus3();
    
    // Limpar sele√ß√£o de POP
    clearPopFields();
    
    // Limpar todas as imagens
    const previewContainers = document.querySelectorAll('[id^="preview"]');
    previewContainers.forEach(container => {
        container.innerHTML = '';
    });
    
    // Limpar arrays de imagens
    for (const key in formImages) {
        delete formImages[key];
    }
    
    // Limpar assinaturas
    clearSig('sigTech');
    clearSig('sigResp');
    
    // Limpar campos de texto espec√≠ficos (caso n√£o sejam resetados pelo form.reset())
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.value = '';
    });
    
    // Limpar inputs de texto
    const inputs = document.querySelectorAll('input[type="text"]');
    inputs.forEach(input => {
        if (!input.id.includes('numeroOS')) { // N√£o limpar n√∫mero da OS
            input.value = '';
        }
    });
    
    alert('Formul√°rio limpo com sucesso! Pronto para criar uma nova OS.');
}

/* ========== Inicializa√ß√£o ========== */
window.addEventListener('load', function(){
  document.getElementById('btnUseNow').addEventListener('click', function(){
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    const dtLocal = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
    document.getElementById('dataHora').value = dtLocal;
  });
});

window.addEventListener('load', function(){
  populatePOP();
  gerarNumeroOS();
  fillNowDateTime();
  fillHoraInicio();
  fillDataEstimadaPlus3();

  document.getElementById('btnUseNow').addEventListener('click', function(){
    fillNowDateTime();
  });

  const link = document.getElementById('mapsLink');
  if(link.href === '#' || !document.getElementById('localizacao').value) link.style.opacity=0.5;

  initSignatureCanvas('sigTech');
  initSignatureCanvas('sigResp');
});
</script>
</body>
</html>
